<!doctype html>
<meta name=”renderer” content=”webkit”>
<meta http-equiv=”X-UA-Compatible” content=”IE=Edge,chrome=1″ >
<head>
    <meta charset="utf-8">
    <title>登录页</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="{$assets.img}animated_favicon.gif" type="image/gif" />
    <link href="{$assets.css}" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="__JQUERY__"></script>
    <script type="text/javascript" src="__LIB__/jquery/jquery.cookie.js"></script>
    <script type="text/javascript" src="__LAYUI_JS__"></script>

</head>

<body>
<div class="login-layout">
    <!--<div class="logo">
        <img src="logo2.png">
    </div>-->
    <form action="" name='theForm' id="theForm" method="post">
        <div class="login-form" style="position: relative">
            <div class="formContent">
                <div class="title">登 陆</div>

                <div class="formInfo">
                    <div class="formText">
                        <i class="icon icon-user"></i>
                        <input type="text" name="username" autocomplete="off" class="input-text" value="" placeholder="用户名" />
                    </div>
                    <div class="formText">
                        <i class="icon icon-pwd"></i>
                        <input type="password" name="password" autocomplete="off" class="input-text" value="" placeholder="密  码" />
                    </div>
                    <div class="formText">
                        <i class="icon icon-chick"></i>
                        <input type="text" name="vertify" id="vertify" autocomplete="off" maxlength="4" class="input-text chick_ue" value="" placeholder="验证码" />
                        <img src="{:captcha_src()}" class="chicuele" id="imgVerify" alt="" onclick="javascript:this.src='{:captcha_src()}?tm='+Math.random();" >
                    </div>
                    <div class="formText">
                        <!--<div class="checkbox">
                            <div class="cur">
                                <input type="hidden" value="1" name="remember"/>
                            </div>
                        </div>
                       <span class="span">保存信息</span>-->
                        <!--<a href="" class="forget_pwd">忘记密码？</a>-->
                    </div>
                    <div class="formText submitDiv">
                            <span class="submit_span">
                                <input type="button" name="submit" class="sub" value="登 录">
                            </span>
                    </div>


                </div>
            </div>
            <div id="error" style="position: absolute;left:0px;bottom: 12px;text-align: center;width:441px;">

            </div>
        </div>
    </form>
</div>
<div id="bannerBox">
    <ul id="slideBanner" class="slideBanner">
        <li><img src="{$assets.img}bg.png"></li>
        <!-- <li><img src=""></li>
         <li><img src=""></li>-->
    </ul>
</div>
<script>
    var usernameLoginURL="{:url('admin/api.Login/username')}";
    var captcha="{:url('admin/index/captcha')}";
    var adminCtenterURL='{:url("admin/center/index")}';
</script>
<script type="text/javascript">
    //跳出框架
    $(function(){
        if(self !== top){
            top.location.href = self.location.href;
        }
    });
    $(function(){
        $(".formText .input-text").focus(function(){
            $(this).parent().addClass("focus");
        });

        $(".formText .input-text").blur(function(){
            $(this).parent().removeClass("focus");
        });

        $(".checkbox").click(function(){
            if($(this).hasClass("checked")){
                $(this).removeClass("checked");
                $('input[name=remember]').val(0);
            }else{
                $(this).addClass("checked");
                $('input[name=remember]').val(1);
            }
        });

        $(".formText .input-yzm").focus(function(){
            $(this).prev().show();
        });

        $(".formText").blur(function(){
            $(this).prev().hide();
        });
    });

    $(function(){
        var valve=true;
        var url='{$url ?? ""}'
        function loginsubmit(){
            var username=true;
            var password=true;
            var vertify=true;
            //防止重复提交
            if(valve===false){
                return false;
            }
            if($('#theForm input[name=username]').val() == ''){
                $('#error').html('<span class="error">用户名不能为空!</span>');
                $('#theForm input[name=username]').focus();
                username = false;
                return false;
            }

            if($('#theForm input[name=password]').val() == ''){
                $('#error').html('<span class="error">密码不能为空!</span>');
                $('#theForm input[name=password]').focus();
                password = false;
                return false;
            }

            if($('#theForm input[name=vertify]').val() == ''){
                $('#error').html('<span class="error">验证码不能为空!</span>');
                $('#theForm input[name=vertify]').focus();
                vertify = false;
                return false;
            }
            if(vertify && $('#theForm input[name=username]').val() != '' && $('#theForm input[name=password]').val() != ''){
                $.ajax({
                    async:false,
                    url:usernameLoginURL,
                    data:{'username':$('#theForm input[name=username]').val(),'password':$('#theForm input[name=password]').val(),code:$('#theForm input[name=vertify]').val()},
                    type:'post',
                    dataType:'json',
                    beforeSend:function(xhr){
                        valve=false;
                    },
                    success:function(res){
                        if(res.code != 0){
                            $('#error').html('<span class="error">'+res.msg+'</span>');
                            if (typeof(res.data) != "undefined"){
                                fleshVerify();
                            }
                            username=false;
                            password=false;
                            $('input[name="submit"]').val('重 新 登 录');
                            return false;
                        }else{
                            if (typeof res.data.url == "undefined"){
                                if (!url){
                                    url=adminCtenterURL;
                                }
                                top.location.href = url;
                            }else {
                                top.location.href = res.data.url;
                            }

                            $('input[name="submit"]').val('登 录 成 功');
                        }
                    },
                    error : function(XMLHttpRequest, textStatus, errorThrown) {
                        $('#error').html('<span class="error">网络上出现了一个错误!</span>');
                        $('input[name="submit"]').val('重 新 登 录');
                    },
                    complete:function () {
                        valve=true;
                    }
                });
            }else{
                return false;
            }
        }

        $('.submit_span .sub').on('click',function(){
            $('.code').show();
        });
        $('#theForm input[name=submit]').on('click',function(){
            loginsubmit();
        });

        $(document).click(function(e){
            if(e.target.name !='vertify' && !$(e.target).parents("div").is(".submitDiv")){
                $('.code').hide();
            }
        });
        //回车提交
        $(document).keyup(function(event){
            if(event.keyCode ==13){
                var isFocus=$("#vertify").is(":focus");
                if(true==isFocus){
                    loginsubmit();
                }
            }
        });
    });


    function fleshVerify(){
        //$('#imgVerify').attr('src','/captcha.html?id='+Math.random());//重载验证码
        $('#imgVerify').attr('src',captcha+'?tm='+Math.random());
    }


</script>
</body>
</html>
